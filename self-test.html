<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>CFG | Self-Test /api/lead</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow, noarchive">
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 24px; background:#0b1020; color:#e7ebff; }
    .card { max-width: 780px; margin:auto; background:#121833; border:1px solid #273057; border-radius:16px; padding:20px; box-shadow: 0 8px 20px rgba(0,0,0,.35);}
    h1 { font-size:22px; margin:0 0 8px }
    .muted { color:#9fb0ff; font-size:13px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0 16px;}
    button { border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; background:#3b82f6; color:#fff; }
    button.secondary { background:#64748b; }
    button:disabled { opacity:.6; cursor:not-allowed;}
    pre { background:#0e142b; border:1px solid #273057; border-radius:12px; padding:12px; max-height:380px; overflow:auto; }
    .tag { display:inline-block; padding:3px 8px; border:1px solid #3b82f6; border-radius:999px; font-size:12px; margin-right:6px; }
  </style>

<!-- CFG GA4 init v3 -->
<script>
(function(){
  window.CFG_SLOT = window.CFG_SLOT || {};
  window.cfgOpenSlot = function(e){ try{ e && e.preventDefault && e.preventDefault(); }catch(_e){}; try{ if(window.CFG_SLOT && typeof window.CFG_SLOT.open==="function"){ window.CFG_SLOT.open(); return false;} }catch(_e){}; try{ var md=document.getElementById("slot-modal"); if(md){ md.style.display="block"; md.removeAttribute("hidden"); return false;} }catch(_e){}; return false; };
  var GA_ID = 'G-D7QRTPW2F3';
  function hasConsent(){
    try {
      if (localStorage.getItem('cfg_analytics') === '1') return true;
      return document.cookie.split('; ').some(p => p.trim() === 'cfg_analytics=1');
    } catch(e){ return false; }
  }
  function grantConsent(){
    try {
      localStorage.setItem('cfg_analytics','1');
      var d = new Date(); d.setFullYear(d.getFullYear()+1);
      document.cookie = 'cfg_analytics=1; path=/; expires='+d.toUTCString();
    } catch(e){}
    loadGA();
  }
  function loadGA(){
    if (window.__ga_loaded) return;
    window.__ga_loaded = true;
    var s = document.createElement('script');
    s.async = true;
    s.src = 'https://www.googletagmanager.com/gtag/js?id='+GA_ID;
    document.head.appendChild(s);
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', GA_ID, { anonymize_ip: true, transport_type: 'beacon' });
  }
  // Wire up common accept buttons & custom events
  function hookButtons(){
    var selectors = ['[data-analytics-consent]','[data-cookie-accept]','#cookie-accept','[data-cc="accept"]','.cookie-accept'];
    selectors.forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(btn){
        btn.addEventListener('click', grantConsent, {once:true});
      });
    });
  }
  document.addEventListener('cfg:consent-granted', grantConsent);
  document.addEventListener('DOMContentLoaded', function(){
    hookButtons();
    if (hasConsent()) loadGA();
  });
})();
</script>
<style id="cfg-lang-style">
/* CFG v5 language chips (force override) */
.lang-chip{ 
  display:inline-block; padding:6px 10px; border-radius:999px;
  border:1px solid #93C5FD !important; 
  background:transparent !important;
  color:#E5E7EB !important; 
  text-decoration:none !important; 
}
.lang-chip.active, .lang-chip[aria-current="true"], .lang-chip[data-active="1"]{
  border-color:transparent !important;
  background:linear-gradient(135deg, #4F46E5, #06B6D4) !important;
  color:#FFFFFF !important;
}
</style>
<style id="cfg-cookie-style">
#cookie-banner{position:fixed;left:16px;right:16px;bottom:16px;background:#0B1220DD;color:#E5E7EB;border:1px solid #374151;padding:12px 16px;border-radius:14px;display:none;z-index:9999;backdrop-filter:saturate(140%) blur(6px);box-shadow:0 8px 24px rgba(0,0,0,.25)}
#cookie-banner p{margin:0 0 8px 0;line-height:1.4;font-size:14px}
#cookie-banner .row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
#cookie-banner button{padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
#cookie-banner .primary{background:#10B981;color:#fff}
#cookie-banner .secondary{background:#111827;color:#E5E7EB;border:1px solid #374151}
#cookie-banner a{color:#93C5FD}
</style>
<style id="cfg-slot-style">
.slot-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(2px);display:none;z-index:10000}

.slot-modal header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #1F2937}
.slot-modal header h3{margin:0;font-size:18px}
.slot-modal .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;padding:14px 16px}
.slot-modal .btn{display:flex;align-items:center;gap:8px;justify-content:center;padding:10px;border:1px solid #374151;border-radius:12px;background:#0F172A;color:#E5E7EB;text-decoration:none;cursor:pointer}
.slot-modal .btn.primary{background:linear-gradient(135deg,#4F46E5,#06B6D4);border-color:transparent;color:#fff}
.slot-modal footer{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid #1F2937}
.slot-modal .muted{opacity:.8;font-size:12px}
.slot-close{background:transparent;border:none;color:#9CA3AF;font-size:22px;cursor:pointer}
@media (max-width:480px){ .slot-modal .grid{grid-template-columns:1fr} }
</style>
<style id="cfg-slot-fix">
/* Robust modal fix */
.slot-modal[hidden]{display:none !important;}
.slot-modal{position:fixed; inset:0; display:flex !important; align-items:flex-start; justify-content:center; padding:8vh 16px; z-index:3000 !important; background:transparent !important;}
.slot-modal__backdrop{position:absolute; inset:0; background:rgba(0,0,0,.45) !important; z-index:0;}
.slot-modal__dialog{position:relative; z-index:1; background:#0B1220; color:#E5E7EB; max-width:720px; width:100%; border-radius:16px; border:1px solid #1F2937; box-shadow:0 20px 48px rgba(0,0,0,.35);}
.slot-modal__grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:10px; padding:14px 16px;}
.slot-modal__actions{display:flex; justify-content:flex-end; padding:12px 16px; border-top:1px solid #1F2937;}
.slot-modal__title{margin:0; padding:14px 16px; border-bottom:1px solid #1F2937; font-size:18px;}
</style>
<style id="cfg-slot-fix-strong">
/* CFG strong modal overrides */
body.modal-open{overflow:hidden !important;}
.slot-modal[hidden]{display:none !important;}
.slot-modal{
  position:fixed !important; inset:0 !important; 
  display:flex !important; align-items:flex-start !important; justify-content:center !important;
  padding:8vh 16px !important; z-index:4000 !important; background:transparent !important;
}
.slot-modal__backdrop{
  position:absolute !important; inset:0 !important; 
  background:rgba(0,0,0,.45) !important; z-index:4000 !important;
}
.slot-modal__dialog{
  position:relative !important; z-index:4001 !important; 
  background:#0B1220 !important; color:#E5E7EB !important;
  max-width:720px !important; width:100% !important; 
  border-radius:16px !important; border:1px solid #1F2937 !important; 
  box-shadow:0 20px 48px rgba(0,0,0,.35) !important;
  margin:0 auto !important; transform:none !important; 
  max-height:calc(100vh - 16vh) !important; overflow:auto !important;
}
.slot-modal__title{margin:0 !important; padding:14px 16px !important; border-bottom:1px solid #1F2937 !important; font-size:18px !important;}
.slot-modal__grid{display:grid !important; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)) !important; gap:10px !important; padding:14px 16px !important;}
.slot-modal__actions{display:flex !important; justify-content:flex-end !important; padding:12px 16px !important; border-top:1px solid #1F2937 !important;}
</style>
<script defer src="/analytics/ga-init.js"></script><script defer src="/analytics/ux-metrics.js"></script></head>
<body>
<div class="card">
  <h1>CFG · Self-Test</h1>
  <div class="muted">Проверка связки <code>/api/lead → Google Apps Script → Google Sheets</code>.</div>
  <p>
    <span class="tag" id="envTag"></span>
    <span class="tag" id="originTag"></span>
    <span class="tag" id="timeTag"></span>
  </p>
  <div class="row">
    <button id="btnClient">Тест: клиентская заявка</button>
    <button id="btnPartner" class="secondary">Тест: партнёрская заявка</button>
    <button id="btnClear" class="secondary">Очистить лог</button>
  </div>
  <pre id="log"></pre>
</div>
<script>
(function () {
  const $ = (s)=>document.querySelector(s);
  const logEl = $('#log');
  const env = (location.hostname === 'cfg-consulting.vercel.app') ? 'production'
            : (location.hostname.endsWith('.vercel.app') ? 'preview' : 'unknown');
  $('#envTag').textContent = 'ENV: ' + env;
  $('#originTag').textContent = 'ORIGIN: ' + location.origin;
  $('#timeTag').textContent = (new Date()).toISOString();

  function log(){ logEl.textContent += Array.from(arguments).join(' ') + "\n"; logEl.scrollTop = logEl.scrollHeight; }
  function ms(s){ return (Math.round(s*10)/10) + 'ms'; }

  async function send(kind){
    $('#btnClient').disabled = true; $('#btnPartner').disabled = true;
    const started = performance.now(); const stamp = new Date().toISOString();
    const payload = {
      type: kind,
      name: `SELFTEST ${env.toUpperCase()} ${kind.toUpperCase()} ${stamp}`,
      phone: '+7 999 000-00-00',
      email: `selftest+${env}@example.com`,
      company: kind==='partner' ? 'Partner Test LLC' : 'Client Test LLC',
      role: kind==='partner' ? 'Партнёр' : 'Клиент',
      message: 'Автоматический тест через self-test.html',
      locale: 'ru',
      page: location.pathname,
      referrer: document.referrer || '',
      utm_source: 'selftest', utm_medium: env, utm_campaign: 'api-check'
    };
    try {
    const API = (location.origin && location.origin.startsWith('http')) 
  ? '/api/lead' 
  : 'https://cfg-consulting.vercel.app/api/lead';
const ENV = location.origin ? (location.origin.startsWith('http') ? 'web' : 'file') : 'unknown';
try{ var el=document.getElementById('apiInfo'); if(el){ el.textContent='Endpoint: '+API; }}catch(e){}
function curl(payload){
  const body = JSON.stringify(payload).replace(/"/g,'\\\"');
  return `curl -i -X POST '${API.replace(/^\//,'https://cfg-consulting.vercel.app/')}' -H 'Content-Type: application/json' -d "${body}"`;
}

      const res = await fetch(API, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      const duration = performance.now() - started;
      const text = await res.text();
      let data; try { data = JSON.parse(text); } catch(e){ data = text; }
      log(`[${stamp}] ${kind.toUpperCase()} → status ${res.status} in ${ms(duration)}`);
      log(typeof data === 'string' ? data : JSON.stringify(data,null,2));
      log('—'.repeat(60));
    } catch (e){ log('Network error:', e && e.message || e); }
    finally { $('#btnClient').disabled = false; $('#btnPartner').disabled = false; }
  }

  $('#btnClient').onclick = () => send('client');
  $('#btnPartner').onclick = () => send('partner');
  $('#btnClear').onclick = () => (logEl.textContent = '');
})();
</script>

<script>
// CFG unified lead sender v3 — injected
(function(){
  function qs(form, name){ return form.querySelector('[name="'+name+'"]'); }
  function getVal(form, name){ const el = qs(form, name); return el ? el.value.trim() : ''; }
  function getLocale(){ try { return document.documentElement.lang || (window.CFG_LOCALE || '').toString() || ''; } catch(e){ return ''; } }
  function getUTM(){
    const params = new URLSearchParams(location.search);
    const keys = ['utm_source','utm_medium','utm_campaign','utm_term','utm_content'];
    const out = {};
    keys.forEach(k => { if (params.get(k)) out[k] = params.get(k); });
    return out;
  }
  async function sendLead(form){
    const hp = getVal(form, 'company_site'); // honeypot
    if (hp) return Promise.reject(new Error('honeypot_filled'));

    // Basic payload (common names across pages)
    const payload = {
      name: getVal(form, 'name') || getVal(form, 'full_name') || '',
      company: getVal(form, 'company') || '',
      inn: getVal(form, 'inn') || '',
      email: getVal(form, 'email') || '',
      phone: getVal(form, 'phone') || '',
      message: getVal(form, 'message') || getVal(form, 'task') || getVal(form, 'comment') || '',
      // meta
      locale: getLocale(),
      page_url: location.href,
      referrer: document.referrer || '',
      utm: getUTM()
    };

    const btn = form.querySelector('button[type="submit"], [type="submit"]');
    const origText = btn && (btn.textContent || btn.value);

    function setState(t){ if (btn) { if (btn.tagName === 'BUTTON') btn.textContent = t; else btn.value = t; } document.dispatchEvent(new CustomEvent('cfg:form-state', {detail:{state:t}})); }

    try{
      setState('Отправка…');
      const res = await fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const ok = res.ok;
      let data = {};
      try { data = await res.json(); } catch(e){}
      if (!ok) throw new Error('bad_status_'+res.status);
      setState('Готово ✓');
      document.dispatchEvent(new CustomEvent('cfg:form-success', {detail:{payload, data}}));
      form.reset();
      return data;
    }catch(err){
      setState('Ошибка');
      document.dispatchEvent(new CustomEvent('cfg:form-error', {detail:{error: (err && err.message) || 'unknown', payload}}));
      throw err;
    }finally{
      setTimeout(()=> setState(origText || 'Отправить'), 1400);
    }
  }

  // Attach to all forms that carry data-cfg-lead or id matches known ids
  function wireForm(form){
    if (form.__cfg_wired) return;
    form.__cfg_wired = true;
    form.addEventListener('submit', function(e){
      e.preventDefault();
      sendLead(form).catch(()=>{});
    });
  }

  document.querySelectorAll('form[data-cfg-lead], form#lead-form, form#partner-form').forEach(wireForm);
  // If forms injected later
  const mo = new MutationObserver(() => {
    document.querySelectorAll('form[data-cfg-lead], form#lead-form, form#partner-form').forEach(wireForm);
  });
  mo.observe(document.documentElement, {subtree:true, childList:true});
})();
</script>
<script id="cfg-lang-active">
document.addEventListener('DOMContentLoaded', function(){
  var lang = (document.documentElement.getAttribute('lang')||'').toLowerCase();
  var lc = (lang.split('-')[0]||'ru');
  document.querySelectorAll('.lang-chip').forEach(function(el){
    // clear inline style that might lock colors
    el.style.background=''; el.style.color=''; el.style.border='';
    var loc = (el.getAttribute('data-locale')||'').toLowerCase();
    el.classList.remove('active');
    if (loc === lc) { 
      el.classList.add('active'); 
      el.setAttribute('aria-current','true');
      el.setAttribute('data-active','1');
    } else {
      el.removeAttribute('aria-current');
      el.setAttribute('data-active','0');
    }
  });
});
</script>
<script id="cfg-cookie-banner">
(function(){
  function t(lang){
    var ru = {
      text: 'Мы используем только аналитические cookie для улучшения работы сайта.',
      accept: 'Принять',
      decline: 'Отклонить',
      policy: 'Политика'
    };
    var en = {
      text: 'We use analytics-only cookies to improve the site experience.',
      accept: 'Accept',
      decline: 'Decline',
      policy: 'Privacy'
    };
    var zh = {
      text: '我们仅使用分析类 cookie 以改进网站体验。',
      accept: '同意',
      decline: '拒绝',
      policy: '隐私政策'
    };
    var map = {ru:ru,en:en,zh:zh};
    var lc = (lang||'ru').split('-')[0];
    return map[lc] || ru;
  }
  function hasConsent(){
    try {
      if (localStorage.getItem('cfg_analytics') === '1') return true;
      return document.cookie.split('; ').some(p => p.trim() === 'cfg_analytics=1');
    } catch(e){ return false; }
  }
  function markDeclined(){
    try {
      localStorage.setItem('cfg_analytics','0');
      var d = new Date(); d.setFullYear(d.getFullYear()+1);
      document.cookie = 'cfg_analytics=0; path=/; expires='+d.toUTCString();
    }catch(e){}
  }
  function grantConsent(){
    try {
      localStorage.setItem('cfg_analytics','1');
      var d = new Date(); d.setFullYear(d.getFullYear()+1);
      document.cookie = 'cfg_analytics=1; path=/; expires='+d.toUTCString();
    }catch(e){}
    document.dispatchEvent(new CustomEvent('cfg:consent-granted'));
  }
  function inject(){
    if (document.getElementById('cookie-banner')) return;
    var lang = (document.documentElement.getAttribute('lang')||'').toLowerCase();
    var i18n = t(lang);
    var div = document.createElement('div');
    div.id = 'cookie-banner';
    div.innerHTML = '<p>'+i18n.text+' <a href="/privacy.html" target="_blank" rel="noopener">'+i18n.policy+'</a>.</p>' +
      '<div class="row">' +
      '<button type="button" class="secondary" data-cookie-decline>'+i18n.decline+'</button>' +
      '<button type="button" class="primary" data-cookie-accept>'+i18n.accept+'</button>' +
      '</div>';
    document.body.appendChild(div);
    div.style.display = 'block';
    div.querySelector('[data-cookie-accept]').addEventListener('click', function(){
      grantConsent();
      div.remove();
    }, {once:true});
    div.querySelector('[data-cookie-decline]').addEventListener('click', function(){
      markDeclined();
      div.remove();
    }, {once:true});
  }
  document.addEventListener('DOMContentLoaded', function(){
    if (!hasConsent()) inject();
  });
})();
</script>




<script id="cfg-slot-script">
(function(){
  var EMAIL = "C.F.G.consulting@bk.ru";
  function enc(s){ try { return encodeURIComponent(s); } catch(e){ return s; } }
  function utmString() {
    try {
      var p = new URLSearchParams(location.search);
      var keys = ['utm_source','utm_medium','utm_campaign','utm_term','utm_content'];
      var parts = []; keys.forEach(function(k){ if (p.get(k)) parts.push(k+'='+p.get(k)); });
      return parts.length ? ('&'+parts.join('&')) : '';
    }catch(e){ return ''; }
  }
  // Self-test buttons will call window.cfgOpenDefaultMail(payload)
  window.cfgOpenDefaultMail = function(payload){
    try{
      var subject = payload && payload.subject || 'CFG: заявка';
      var body = (payload && payload.text || '').trim();
      body += "\n\n—\nСтр.: "+location.href+"\nRef.: "+(document.referrer||'')+utmString();
      var href = 'mailto:'+EMAIL+'?subject='+enc(subject)+'&body='+enc(body);
      location.href = href;
    }catch(e){ console.error(e); }
  };
})();
</script>

<script>
function setCurl(payload){
  try{
    var box = document.getElementById('curlBox');
    if (!box) return;
    box.style.display='block';
    box.textContent = 'CLI тест (скопируйте и выполните в терминале): ' + curl(payload);
  }catch(e){}
}
</script>

</body>
</html>