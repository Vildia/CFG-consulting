<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>CFG | Self‑Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{--bg:#0b1020;--card:#121833;--mut:#9fb0ff;--fg:#e7ebff;--br:#273057}
  body{margin:24px;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  .card{max-width:900px;margin:auto;background:var(--card);border:1px solid var(--br);border-radius:16px;padding:20px;box-shadow:0 8px 20px rgba(0,0,0,.35)}
  h1{margin:0 0 6px}
  p{margin:6px 0 12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 12px}
  button{border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;background:#3b82f6;color:#fff}
  button.secondary{background:#64748b}
  pre{white-space:pre-wrap;background:#0e142b;border:1px solid var(--br);border-radius:12px;padding:12px;min-height:160px}
</style>
</head>
<body>
<div class="card">
  <h1>CFG · Self‑Test</h1>
  <p class="muted">Проверка API. 1) «Статус /api/health», 2) «Статус https://script.google.com/macros/s/AKfycbwFOxaAtkPV4hsk3_gHGdrS4dlISHyVtj2f8TrxjTI_ZQP7j8cd2N8XVUdYpPzUNPv73A/exec», 3) «Тест POST». При ошибке — «Тест GET compat».</p>
  <div class="row">
    <button id="health">Статус /api/health</button>
    <button id="probe">Статус https://script.google.com/macros/s/AKfycbwFOxaAtkPV4hsk3_gHGdrS4dlISHyVtj2f8TrxjTI_ZQP7j8cd2N8XVUdYpPzUNPv73A/exec</button>
    <button id="post">Тест POST</button>
    <button id="get">Тест GET compat</button>
    <button id="clear" class="secondary">Очистить лог</button>
  </div>
  <pre id="out">—</pre>
</div>
<script>
(function(){
  const out = document.getElementById('out');
  const log = (o)=>{ out.textContent = (typeof o==='string'? o : JSON.stringify(o, null, 2)); };

  document.getElementById('clear').onclick = ()=> log('—');
  document.getElementById('health').onclick = async ()=>{
    try{ const r = await fetch('/api/health'); const j = await r.json(); log(j); }catch(e){ log(String(e)); }
  };
  document.getElementById('probe').onclick = async ()=>{
    try{ const r = await fetch('https://script.google.com/macros/s/AKfycbwFOxaAtkPV4hsk3_gHGdrS4dlISHyVtj2f8TrxjTI_ZQP7j8cd2N8XVUdYpPzUNPv73A/exec'); const j = await r.json(); log(j); }catch(e){ log(String(e)); }
  };
  document.getElementById('post').onclick = async ()=>{
    try{
      const payload = { action:'selftest', name:'Test', email:'test@example.com', locale:'ru', page_url:location.href, referrer:document.referrer||'', utm:{} };
      const r = await fetch('https://script.google.com/macros/s/AKfycbwFOxaAtkPV4hsk3_gHGdrS4dlISHyVtj2f8TrxjTI_ZQP7j8cd2N8XVUdYpPzUNPv73A/exec', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const t = await r.text(); let j; try{ j = JSON.parse(t); }catch(_){}
      log(j || t);
    }catch(e){ log(String(e)); }
  };
  document.getElementById('get').onclick = async ()=>{
    try{
      const qs = new URLSearchParams({ compat:'1', action:'selftest', name:'Test', locale:'ru', page_url:location.href });
      const r = await fetch('https://script.google.com/macros/s/AKfycbwFOxaAtkPV4hsk3_gHGdrS4dlISHyVtj2f8TrxjTI_ZQP7j8cd2N8XVUdYpPzUNPv73A/exec?'+qs.toString());
      const t = await r.text(); let j; try{ j = JSON.parse(t); }catch(_){}
      log(j || t);
    }catch(e){ log(String(e)); }
  };
})();
</script>
</body>
</html>
